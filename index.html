<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>WebCoder Pro - Mobile Edition</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <style>
        /* --- TEMA DARK --- */
        :root {
            --bg-dark: #09090b;
            --bg-panel: #18181b;
            --border: #27272a;
            --accent: #8b5cf6;
            
            /* Syntax Highlighting */
            --syntax-text: #f8f8f2;
            --syntax-keyword: #ff79c6;
            --syntax-string: #f1fa8c;
            --syntax-tag: #ff79c6;
            --syntax-attr: #50fa7b;
            --syntax-comment: #6272a4;
            --syntax-func: #8be9fd;
            --syntax-number: #bd93f9;
            --syntax-selector: #ffb86c;
            --syntax-bracket: #f8f8f2;
        }

        body {
            background-color: var(--bg-dark);
            color: #e4e4e7;
            font-family: 'Inter', sans-serif;
            overflow: hidden; /* App-like feel */
        }

        /* --- EDITOR ENGINE --- */
        .editor-container {
            position: relative;
            width: 100%;
            height: 100%;
            background-color: var(--bg-dark);
            overflow: hidden; 
        }

        .editor-textarea, .editor-highlight {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            padding: 1rem;
            margin: 0;
            border: none;
            font-family: 'Fira Code', monospace;
            font-size: 14px;
            line-height: 1.6;
            tab-size: 2;
            white-space: pre;
            overflow: auto;
            text-align: left;
        }
        
        /* Ajuste para mobile */
        @media (max-width: 640px) {
            .editor-textarea, .editor-highlight {
                font-size: 13px; /* Fonte um pouco menor no mobile */
                padding: 12px;
            }
        }

        .editor-textarea {
            background: transparent;
            color: transparent;
            caret-color: #a855f7; /* Roxo */
            z-index: 2;
            resize: none;
            outline: none;
        }

        .editor-highlight {
            background-color: var(--bg-dark);
            color: var(--syntax-text);
            z-index: 1;
            pointer-events: none;
        }

        /* Syntax Colors */
        .token-keyword { color: var(--syntax-keyword); font-weight: bold; }
        .token-string { color: var(--syntax-string); }
        .token-tag { color: var(--syntax-tag); }
        .token-attr { color: var(--syntax-attr); font-style: italic; }
        .token-comment { color: var(--syntax-comment); }
        .token-func { color: var(--syntax-func); }
        .token-number { color: var(--syntax-number); }
        .token-selector { color: var(--syntax-selector); }
        .token-bracket { color: #f8f8f2; }

        /* --- UI ELEMENTS --- */
        .tab-btn {
            background: var(--bg-panel);
            color: #71717a;
            border-bottom: 2px solid transparent;
            transition: all 0.2s;
        }
        .tab-btn.active { background: var(--bg-dark); color: #fff; }
        .tab-btn.active-html { border-bottom-color: #f97316; }
        .tab-btn.active-css { border-bottom-color: #3b82f6; }
        .tab-btn.active-js { border-bottom-color: #eab308; }

        /* Scrollbar */
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: var(--bg-dark); }
        ::-webkit-scrollbar-thumb { background: #3f3f46; border-radius: 3px; }

        /* --- INTELLISENSE FLOATING BOX --- */
        #suggestion-box {
            position: absolute;
            background-color: #1e1e2e;
            border: 1px solid #45475a;
            border-radius: 6px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.5);
            z-index: 100;
            width: 220px;
            max-height: 200px;
            overflow-y: auto;
            display: none; /* Hidden by default */
            flex-direction: column;
        }

        .suggestion-item {
            padding: 8px 10px;
            font-size: 12px;
            font-family: 'Fira Code', monospace;
            color: #cdd6f4;
            cursor: pointer;
            border-bottom: 1px solid #313244;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .suggestion-item:last-child { border-bottom: none; }
        
        .suggestion-item:hover, .suggestion-item.active {
            background-color: var(--accent);
            color: white;
        }
        
        .suggestion-icon {
            opacity: 0.8;
            font-size: 11px;
            min-width: 16px;
            text-align: center;
        }
        .icon-snippet { color: #facc15; } /* Amarelo para Snippets */
        .icon-tag { color: #f87171; } /* Vermelho para Tags */
        .icon-prop { color: #60a5fa; } /* Azul para Props */

        /* --- LAYOUT SYSTEM (Desktop & Mobile) --- */
        /* Base: Oculto por padr√£o */
        .view-editor, .view-preview { display: none; flex-direction: column; height: 100%; }

        /* MODO: EDITOR FULL (Mobile & Desktop) */
        body.mode-editor .view-editor { display: flex; width: 100%; }
        
        /* MODO: PREVIEW FULL (Mobile & Desktop) */
        body.mode-preview .view-preview { display: flex; width: 100%; }

        /* MODO: SPLIT (Apenas Desktop > 768px) */
        @media (min-width: 768px) {
            body.mode-split .view-editor { display: flex; width: 50%; }
            body.mode-split .view-preview { display: flex; width: 50%; }
        }
        /* Fallback Split no Mobile (For√ßa Editor) */
        @media (max-width: 767px) {
            body.mode-split .view-editor { display: flex; width: 100%; }
            body.mode-split .view-preview { display: none; }
        }

        /* Estilo dos bot√µes de layout ativos */
        .layout-btn.active {
            background-color: var(--accent);
            color: white;
            border-color: var(--accent);
        }

    </style>
</head>
<!-- Inicia em modo split no desktop ou editor no mobile -->
<body class="flex flex-col h-screen select-none mode-split" id="main-body">

    <!-- Header -->
    <header class="flex items-center justify-between px-3 h-12 shrink-0 bg-[#18181b] border-b border-[#27272a]">
        <div class="flex items-center gap-3">
            <div class="flex items-center gap-2">
                <div class="p-1 bg-violet-600 rounded">
                    <i data-lucide="code-2" class="text-white w-4 h-4"></i>
                </div>
                <h1 class="font-bold text-sm tracking-wide text-white hidden lg:block">WebCoder</h1>
            </div>
            
            <!-- Unified Layout Controls (Visible on all devices) -->
            <div class="flex items-center bg-black/30 rounded p-0.5 border border-[#27272a]">
                <button onclick="setLayout('editor')" id="btn-layout-editor" class="layout-btn p-1.5 rounded text-gray-400 hover:text-white transition" title="Editor Tela Cheia">
                    <i data-lucide="file-code-2" class="w-4 h-4"></i>
                </button>
                <button onclick="setLayout('split')" id="btn-layout-split" class="layout-btn hidden md:flex p-1.5 rounded text-gray-400 hover:text-white transition" title="Dividir Tela">
                    <i data-lucide="columns" class="w-4 h-4"></i>
                </button>
                <button onclick="setLayout('preview')" id="btn-layout-preview" class="layout-btn p-1.5 rounded text-gray-400 hover:text-white transition" title="Preview Tela Cheia">
                    <i data-lucide="monitor" class="w-4 h-4"></i>
                </button>
            </div>
        </div>

        <div class="flex items-center gap-2">
            <button onclick="formatCurrentCode()" class="p-2 text-violet-300 hover:bg-violet-900/30 rounded" title="Formatar C√≥digo">
                <i data-lucide="wand-2" class="w-4 h-4"></i>
            </button>
            <button onclick="runCode()" class="flex items-center gap-1 px-3 py-1.5 text-[10px] font-bold text-white bg-green-600 hover:bg-green-500 rounded shadow-lg shadow-green-900/20 active:scale-95">
                <i data-lucide="play" class="w-3 h-3"></i> <span class="hidden sm:inline">RUN</span>
            </button>
        </div>
    </header>

    <!-- Main Content -->
    <main class="flex flex-1 overflow-hidden relative">
        
        <!-- Editor Section -->
        <div class="view-editor flex-col border-r border-[#27272a] h-full relative">
            
            <!-- Tabs -->
            <div class="flex bg-[#18181b] border-b border-[#27272a] shrink-0">
                <button onclick="switchTab('html')" id="tab-html" class="tab-btn active active-html flex-1 py-2 text-xs font-bold">HTML</button>
                <button onclick="switchTab('css')" id="tab-css" class="tab-btn flex-1 py-2 text-xs font-bold">CSS</button>
                <button onclick="switchTab('js')" id="tab-js" class="tab-btn flex-1 py-2 text-xs font-bold">JS</button>
            </div>

            <!-- Editor Area -->
            <div class="relative flex-1 bg-[#09090b]">
                
                <!-- Floating Suggestion Box -->
                <div id="suggestion-box"></div>

                <!-- HTML -->
                <div id="wrapper-html" class="editor-container">
                    <pre class="editor-highlight" aria-hidden="true"><code id="hl-html"></code></pre>
                    <textarea id="editor-html" class="editor-textarea" spellcheck="false" 
                        oninput="handleInput(event, this); updateHighlight('html')" 
                        onscroll="syncScroll('html')"
                        onclick="hideSuggestions()"
                        placeholder="Digite ! para estrutura base..."></textarea>
                </div>

                <!-- CSS -->
                <div id="wrapper-css" class="editor-container hidden">
                    <pre class="editor-highlight" aria-hidden="true"><code id="hl-css"></code></pre>
                    <textarea id="editor-css" class="editor-textarea" spellcheck="false" 
                        oninput="handleInput(event, this); updateHighlight('css')" 
                        onscroll="syncScroll('css')"
                        onclick="hideSuggestions()"
                        placeholder="Digite * para reset..."></textarea>
                </div>

                <!-- JS -->
                <div id="wrapper-js" class="editor-container hidden">
                    <pre class="editor-highlight" aria-hidden="true"><code id="hl-js"></code></pre>
                    <textarea id="editor-js" class="editor-textarea" spellcheck="false" 
                        oninput="handleInput(event, this); updateHighlight('js')" 
                        onscroll="syncScroll('js')"
                        onclick="hideSuggestions()"></textarea>
                </div>
            </div>

            <!-- Footer Info -->
            <div class="bg-[#18181b] text-[#52525b] text-[10px] py-1 px-2 border-t border-[#27272a] flex justify-between shrink-0 font-mono">
                <span id="status-msg">READY</span>
                <span id="cursor-pos">1:1</span>
            </div>
        </div>

        <!-- Preview Section -->
        <div class="view-preview flex-col bg-[#18181b] h-full relative">
            
            <iframe id="preview-frame" sandbox="allow-scripts allow-modals" class="w-full h-full bg-white"></iframe>
            
            <!-- Console Overlay -->
            <div id="console-logs" class="hidden absolute bottom-0 left-0 right-0 bg-black/90 text-gray-300 text-xs flex flex-col max-h-40 border-t border-gray-800 backdrop-blur-md z-20">
                <div class="flex justify-between items-center p-2 bg-[#18181b]/90 border-b border-gray-800">
                    <span class="font-bold text-gray-400">Console</span>
                    <button onclick="document.getElementById('console-logs').classList.add('hidden')" class="p-1 hover:text-white">‚úï</button>
                </div>
                <div id="logs-content" class="overflow-y-auto p-2 font-mono space-y-1"></div>
            </div>
        </div>
    </main>

    <script>
        lucide.createIcons();

        // --- ESTADO & CONFIG ---
        let currentLang = 'html';
        const editors = { html: document.getElementById('editor-html'), css: document.getElementById('editor-css'), js: document.getElementById('editor-js') };
        const highlights = { html: document.getElementById('hl-html'), css: document.getElementById('hl-css'), js: document.getElementById('hl-js') };
        const suggestionBox = document.getElementById('suggestion-box');
        
        // --- REPOSIT√ìRIO COMPLETO DE SNIPPETS ---
        const snippets = {
            html: {
                // Estrutura
                '!': '<!DOCTYPE html>\n<html lang="pt-BR">\n<head>\n  <meta charset="UTF-8">\n  <meta name="viewport" content="width=device-width, initial-scale=1.0">\n  <title>App</title>\n</head>\n<body>\n  |\n</body>\n</html>',
                'meta': '<meta name="viewport" content="width=device-width, initial-scale=1.0">',
                'link': '<link rel="stylesheet" href="|">',
                'style': '<style>\n  |\n</style>',
                'script': '<script>\n  |\n<\/script>',
                
                // Sem√¢ntica
                'div': '<div>|</div>',
                'span': '<span>|</span>',
                'header': '<header>\n  |\n</header>',
                'footer': '<footer>\n  |\n</footer>',
                'main': '<main>\n  |\n</main>',
                'section': '<section>\n  |\n</section>',
                'nav': '<nav>\n  |\n</nav>',
                'article': '<article>\n  |\n</article>',
                'aside': '<aside>\n  |\n</aside>',
                
                // Texto e Midia
                'h1': '<h1>|</h1>',
                'h2': '<h2>|</h2>',
                'h3': '<h3>|</h3>',
                'p': '<p>|</p>',
                'a': '<a href="|">Link</a>',
                'img': '<img src="|" alt="Imagem">',
                'ul': '<ul>\n  <li>|</li>\n</ul>',
                'ol': '<ol>\n  <li>|</li>\n</ol>',
                'li': '<li>|</li>',
                'br': '<br>',
                'hr': '<hr>',
                
                // Formul√°rios
                'form': '<form action="">\n  |\n</form>',
                'input': '<input type="text" placeholder="|">',
                'inp-pass': '<input type="password" placeholder="Senha">',
                'inp-email': '<input type="email" placeholder="Email">',
                'inp-btn': '<input type="button" value="|">',
                'inp-check': '<input type="checkbox" id="|">',
                'inp-radio': '<input type="radio" name="grupo" id="|">',
                'button': '<button type="button">|</button>',
                'label': '<label for="|">Texto</label>',
                'select': '<select name="Op√ß√µes">\n  <option value="1">Op√ß√£o 1</option>\n  <option value="2">Op√ß√£o 2</option>\n</select>',
                'textarea': '<textarea rows="4" cols="50">|</textarea>',
                
                // Tabelas
                'table': '<table>\n  <thead>\n    <tr>\n      <th>Cabe√ßalho 1</th>\n      <th>Cabe√ßalho 2</th>\n    </tr>\n  </thead>\n  <tbody>\n    <tr>\n      <td>|</td>\n      <td>Dado 2</td>\n    </tr>\n  </tbody>\n</table>',
                'tr': '<tr>\n  <td>|</td>\n</tr>',
                'td': '<td>|</td>'
            },
            
            css: {
                // Seletores Base
                '*': '* {\n  margin: 0;\n  padding: 0;\n  box-sizing: border-box;\n}\n\n|',
                'body': 'body {\n  font-family: sans-serif;\n  background-color: #f4f4f5;\n  color: #18181b;\n  |;\n}',
                
                // Layout Flex/Grid
                'flex': 'display: flex;',
                'flex-col': 'display: flex;\nflex-direction: column;',
                'flex-center': 'display: flex;\njustify-content: center;\nalign-items: center;',
                'flex-between': 'display: flex;\njustify-content: space-between;\nalign-items: center;',
                'grid': 'display: grid;\ngrid-template-columns: repeat(2, 1fr);\ngap: 1rem;',
                
                // Posicionamento
                'rel': 'position: relative;',
                'abs': 'position: absolute;\ntop: 0;\nleft: 0;',
                'fixed': 'position: fixed;\nbottom: 0;\nright: 0;',
                'z': 'z-index: |;',
                
                // Propriedades Comuns
                'm': 'margin: |;',
                'mt': 'margin-top: |;',
                'mb': 'margin-bottom: |;',
                'p': 'padding: |;',
                'pt': 'padding-top: |;',
                'pb': 'padding-bottom: |;',
                'w': 'width: |;',
                'h': 'height: |;',
                'w100': 'width: 100%;',
                'h100': 'height: 100vh;',
                'bg': 'background-color: |;',
                'color': 'color: |;',
                'border': 'border: 1px solid #ccc;',
                'radius': 'border-radius: 4px;',
                'shadow': 'box-shadow: 0 4px 6px rgba(0,0,0,0.1);',
                
                // Texto
                'font': 'font-family: sans-serif;',
                'size': 'font-size: |rem;',
                'bold': 'font-weight: bold;',
                'center': 'text-align: center;',
                'upper': 'text-transform: uppercase;',
                
                // Anima√ß√£o & Efeitos
                'trans': 'transition: all 0.3s ease;',
                'rotate': 'transform: rotate(45deg);',
                'scale': 'transform: scale(1.1);',
                'anim': 'animation: nome 1s infinite;',
                '@key': '@keyframes nomeAnima {\n  0% { opacity: 0; }\n  100% { opacity: 1; }\n}',
                '@media': '@media (max-width: 768px) {\n  |\n}',
                'import': '@import url("|");'
            },
            
            js: {
                // Console & Debug
                'log': 'console.log(|);',
                'warn': 'console.warn(|);',
                'error': 'console.error(|);',
                
                // Vari√°veis & Fun√ß√µes
                'const': 'const | = ;',
                'let': 'let | = ;',
                'fun': 'function |() {\n  \n}',
                'af': 'const | = () => {\n  \n};',
                'return': 'return |;',
                
                // Controle de Fluxo
                'if': 'if (|) {\n  \n}',
                'ife': 'if (|) {\n  \n} else {\n  \n}',
                'else': 'else {\n  |\n}',
                'switch': 'switch (|) {\n  case value:\n    break;\n  default:\n    break;\n}',
                'try': 'try {\n  |\n} catch (error) {\n  console.error(error);\n}',
                
                // Loops
                'for': 'for (let i = 0; i < |; i++) {\n  \n}',
                'forof': 'for (const item of |) {\n  \n}',
                'while': 'while (|) {\n  \n}',
                
                // DOM Manipulation
                'doc': 'document.',
                'get': 'document.getElementById("|")',
                'qs': 'document.querySelector("|")',
                'qsa': 'document.querySelectorAll("|")',
                'ae': 'addEventListener("|", (event) => {\n  \n});',
                'create': 'document.createElement("|")',
                'inner': 'innerHTML = "|";',
                'class': 'classList.add("|");',
                
                // Array Methods
                'map': '.map(item => |)',
                'filter': '.filter(item => |)',
                'forEach': '.forEach(item => {\n  |\n});',
                'find': '.find(item => |)',
                
                // Async & Network
                'fetch': 'fetch("|")\n  .then(response => response.json())\n  .then(data => console.log(data));',
                'async': 'async function |() {\n  try {\n    const res = await fetch("");\n  } catch (e) {\n    console.error(e);\n  }\n}',
                'time': 'setTimeout(() => {\n  |\n}, 1000);',
                'interval': 'setInterval(() => {\n  |\n}, 1000);',
                'prom': 'new Promise((resolve, reject) => {\n  |\n});'
            }
        };

        // Gerar listas de palavras-chave combinando os snippets + palavras soltas
        const commonKeywords = {
            html: ['id', 'class', 'src', 'href', 'type', 'placeholder', 'value', 'name', 'content', 'rel', 'title', 'alt', 'width', 'height', 'style', 'onclick', 'hidden', 'disabled', 'checked', 'required', 'readonly'],
            css: ['display', 'position', 'margin', 'padding', 'border', 'width', 'height', 'top', 'left', 'bottom', 'right', 'z-index', 'overflow', 'float', 'clear', 'color', 'background', 'opacity', 'visibility', 'cursor', 'font-size', 'font-family', 'text-align', 'line-height', 'content'],
            js: ['null', 'undefined', 'true', 'false', 'NaN', 'this', 'new', 'class', 'extends', 'super', 'export', 'import', 'from', 'await', 'async', 'void', 'typeof', 'instanceof', 'Math', 'Date', 'JSON', 'window', 'document', 'location', 'history', 'localStorage', 'sessionStorage']
        };

        const keywords = {
            html: [...new Set([...Object.keys(snippets.html), ...commonKeywords.html])].sort(),
            css: [...new Set([...Object.keys(snippets.css), ...commonKeywords.css])].sort(),
            js: [...new Set([...Object.keys(snippets.js), ...commonKeywords.js])].sort()
        };

        // --- SISTEMA DE LAYOUT UNIFICADO ---
        function setLayout(mode) {
            document.body.classList.remove('mode-editor', 'mode-split', 'mode-preview');
            document.body.classList.add(`mode-${mode}`);
            document.querySelectorAll('.layout-btn').forEach(btn => btn.classList.remove('active', 'text-white'));
            const activeBtn = document.getElementById(`btn-layout-${mode}`);
            if(activeBtn) {
                activeBtn.classList.add('active');
                activeBtn.classList.remove('text-gray-400');
            }
        }

        // Inicializa layout
        if (window.innerWidth < 768) {
            setLayout('editor');
        } else {
            setLayout('split');
        }

        // --- TABS & SCROLL ---
        function switchTab(lang) {
            currentLang = lang;
            ['html', 'css', 'js'].forEach(l => {
                document.getElementById(`wrapper-${l}`).classList.add('hidden');
                document.getElementById(`tab-${l}`).classList.remove('active', `active-${l}`);
            });
            document.getElementById(`wrapper-${lang}`).classList.remove('hidden');
            document.getElementById(`tab-${lang}`).classList.add('active', `active-${lang}`);
            updateHighlight(lang);
            hideSuggestions();
        }

        function syncScroll(lang) {
            const textarea = editors[lang];
            const pre = highlights[lang].parentElement;
            pre.scrollTop = textarea.scrollTop;
            pre.scrollLeft = textarea.scrollLeft;
        }

        // --- L√ìGICA DE INPUT E SUGEST√ÉO ---
        function handleInput(e, textarea) {
            const cursor = textarea.selectionStart;
            const text = textarea.value;
            const textBefore = text.substring(0, cursor);
            
            // Regex melhorado para capturar palavras parciais ou s√≠mbolos de snippet
            // CORRE√á√ÉO: Adicionado '*' ao regex para permitir o snippet de reset do CSS
            const match = textBefore.match(/([a-zA-Z0-9_\-@!*]+)$/);
            const word = match ? match[0] : '';

            if (word.length > 0) {
                // Filtra sugest√µes (case insensitive)
                const list = keywords[currentLang].filter(k => k.toLowerCase().startsWith(word.toLowerCase()));
                if (list.length > 0) {
                    showSuggestions(list, word, textarea);
                    return;
                }
            }
            hideSuggestions();
        }

        // --- POSICIONAMENTO DO POPUP ---
        function getCaretCoordinates(element, position) {
            const div = document.createElement('div');
            const style = getComputedStyle(element);
            Array.from(style).forEach(prop => { div.style[prop] = style.getPropertyValue(prop); });
            div.style.position = 'absolute';
            div.style.visibility = 'hidden';
            div.style.whiteSpace = 'pre-wrap';
            div.style.top = 0; div.style.left = 0;
            div.textContent = element.value.substring(0, position);
            const span = document.createElement('span');
            span.textContent = '|';
            div.appendChild(span);
            document.body.appendChild(div);
            const coordinates = {
                top: span.offsetTop + element.offsetTop - element.scrollTop,
                left: span.offsetLeft + element.offsetLeft - element.scrollLeft,
                lineHeight: parseInt(style.lineHeight)
            };
            document.body.removeChild(div);
            return coordinates;
        }

        function showSuggestions(list, word, textarea) {
            suggestionBox.innerHTML = '';
            
            list.slice(0, 15).forEach((item, idx) => { // Aumentei limite para 15
                const el = document.createElement('div');
                el.className = `suggestion-item ${idx === 0 ? 'active' : ''}`;
                
                // √çcones por tipo
                let icon = 'üîπ'; // Default (Tag/Keyword)
                let className = 'icon-tag';
                
                if(snippets[currentLang][item]) {
                    icon = '‚ö°'; // Snippet
                    className = 'icon-snippet';
                } else if (currentLang === 'css' && item.includes(':')) {
                    icon = 'üé®'; // Propriedade CSS
                    className = 'icon-prop';
                }

                el.innerHTML = `<span class="suggestion-icon ${className}">${icon}</span> ${item}`;
                
                el.onmousedown = (e) => {
                    e.preventDefault();
                    applySuggestion(item, word);
                };
                
                suggestionBox.appendChild(el);
            });

            const coords = getCaretCoordinates(textarea, textarea.selectionStart);
            // Ajuste para n√£o sair da tela na direita
            let leftPos = coords.left;
            if (leftPos + 220 > window.innerWidth) leftPos = window.innerWidth - 230;

            suggestionBox.style.top = `${coords.top + coords.lineHeight + 5}px`;
            suggestionBox.style.left = `${leftPos}px`;
            suggestionBox.style.display = 'flex';
        }

        function hideSuggestions() {
            suggestionBox.style.display = 'none';
        }

        function applySuggestion(suggestion, originalWord) {
            const textarea = editors[currentLang];
            const start = textarea.selectionStart - originalWord.length;
            const end = textarea.selectionStart;
            
            let snippet = snippets[currentLang][suggestion];
            
            // Gerador de Snippet Gen√©rico
            if (!snippet) {
                if(currentLang === 'html') {
                    // Se n√£o for atributo, vira tag
                    const isAttr = commonKeywords.html.includes(suggestion);
                    if (!isAttr) snippet = `<${suggestion}>|</${suggestion}>`;
                    else snippet = `${suggestion}="|"`;
                }
                else if(currentLang === 'css') snippet = `${suggestion}: |;`;
                else snippet = suggestion;
            }

            let finalStr = snippet;
            let offset = snippet.length;
            
            if (snippet.includes('|')) {
                const parts = snippet.split('|');
                finalStr = parts.join('');
                offset = parts[0].length;
            }

            textarea.setRangeText(finalStr, start, end, 'end');
            const newPos = start + offset;
            textarea.setSelectionRange(newPos, newPos);
            
            hideSuggestions();
            updateHighlight(currentLang);
            runCode();
            textarea.focus();
        }

        // --- FORMATTER ---
        function formatCurrentCode() {
            const textarea = editors[currentLang];
            let code = textarea.value;
            let formatted = "";
            let indent = 0;
            const pad = "  ";

            code.split('\n').map(l => l.trim()).filter(l => l.length > 0).forEach(line => {
                if (line.match(/^<\//) || line.startsWith('}') || line.startsWith(']')) {
                    indent = Math.max(0, indent - 1);
                }

                formatted += pad.repeat(indent) + line + "\n";

                const isOpeningTag = (currentLang === 'html') && 
                                     line.match(/^<[a-z0-9]+[^>]*>$/i) && 
                                     !line.match(/<\//) && 
                                     !line.match(/\/>/) &&
                                     !line.startsWith('<!');
                
                if (line.endsWith('{') || line.endsWith('[') || isOpeningTag) {
                    indent++;
                }
            });

            textarea.value = formatted.trim();
            updateHighlight(currentLang);
            runCode();
        }

        // --- TECLAS ESPECIAIS ---
        Object.values(editors).forEach(ed => {
            ed.addEventListener('keydown', e => {
                // Navega√ß√£o nas sugest√µes com Setas
                if (suggestionBox.style.display !== 'none') {
                    if (e.key === 'ArrowDown' || e.key === 'ArrowUp') {
                        e.preventDefault();
                        const items = Array.from(suggestionBox.children);
                        let activeIdx = items.findIndex(el => el.classList.contains('active'));
                        
                        if (activeIdx !== -1) items[activeIdx].classList.remove('active');
                        
                        if (e.key === 'ArrowDown') {
                            activeIdx = (activeIdx + 1) % items.length;
                        } else {
                            activeIdx = (activeIdx - 1 + items.length) % items.length;
                        }
                        
                        items[activeIdx].classList.add('active');
                        items[activeIdx].scrollIntoView({ block: 'nearest' });
                        return;
                    }
                    if (e.key === 'Enter' || e.key === 'Tab') {
                        e.preventDefault();
                        const active = suggestionBox.querySelector('.active');
                        if (active) active.onmousedown(e);
                        return;
                    }
                }
                
                if (e.key === 'Tab') {
                    e.preventDefault();
                    document.execCommand('insertText', false, '  ');
                }
            });
            
            ed.addEventListener('keyup', () => {
                const lines = ed.value.substr(0, ed.selectionStart).split("\n");
                document.getElementById('cursor-pos').innerText = `${lines.length}:${lines[lines.length-1].length + 1}`;
            });
        });

        // --- SYNTAX HIGHLIGHT & RUN ---
        function escapeHtml(text) {
            return text.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;");
        }

        function highlightCode(code, lang) {
            let res = escapeHtml(code);
            if (lang === 'html') {
                res = res.replace(/(&lt;!--[\s\S]*?--&gt;)/g, '<span class="token-comment">$1</span>');
                res = res.replace(/(&lt;\/?)([a-zA-Z0-9-]+)(.*?)(\/?&gt;)/g, (m, p1, p2, p3, p4) => 
                    `<span class="token-tag">${p1}${p2}</span>${p3.replace(/([a-zA-Z-]+)=/g, '<span class="token-attr">$1</span>=')}<span class="token-tag">${p4}</span>`);
            } else if (lang === 'css') {
                res = res.replace(/([^{]+)\{/g, '<span class="token-selector">$1</span>{');
                res = res.replace(/([a-zA-Z-]+):/g, '<span class="token-attr">$1</span>:');
            } else if (lang === 'js') {
                res = res.replace(/(\/\/.*)/g, '<span class="token-comment">$1</span>');
                res = res.replace(/\b(const|let|var|function|return|if|else|for|while|class|try|catch|async|await|new|import|from)\b/g, '<span class="token-keyword">$1</span>');
                res = res.replace(/(["'`].*?["'`])/g, '<span class="token-string">$1</span>');
                res = res.replace(/\b(console|document|window|Math|JSON)\b/g, '<span class="token-func">$1</span>');
            }
            return res + '\n';
        }

        function updateHighlight(lang) {
            highlights[lang].innerHTML = highlightCode(editors[lang].value, lang);
        }

        function runCode() {
            const html = editors.html.value;
            const css = editors.css.value;
            const js = editors.js.value;
            const consoleFix = `<script>
                const _log = console.log; console.log = (...a) => { window.parent.postMessage({type:'log', msg: a.join(' ')}, '*'); _log(...a); };
                const _err = console.error; console.error = (...a) => { window.parent.postMessage({type:'log', msg: 'üî¥ ' + a.join(' ')}, '*'); _err(...a); };
                window.onerror = (m) => window.parent.postMessage({type:'log', msg: 'üî¥ '+m}, '*');
            <\/script>`;
            const blob = new Blob([`<html><head><style>${css}</style></head><body>${html}${consoleFix}<script>${js}<\/script></body></html>`], {type: 'text/html'});
            document.getElementById('preview-frame').src = URL.createObjectURL(blob);
        }

        window.addEventListener('message', (e) => {
            if(e.data.type === 'log') {
                const box = document.getElementById('console-logs');
                const content = document.getElementById('logs-content');
                box.classList.remove('hidden');
                const div = document.createElement('div');
                div.innerHTML = `> ${e.data.msg}`;
                div.className = "border-b border-white/10 pb-1";
                if(e.data.msg.toString().includes('üî¥')) div.style.color = '#f87171';
                content.appendChild(div);
                content.scrollTop = content.scrollHeight;
            }
        });

        // Demo Content
        editors.html.value = '<div class="card">\n  <h1>Super IDE</h1>\n  <p>Tente digitar "table", "flex-center" ou "fetch"!</p>\n  <button onclick="testar()">Click Me</button>\n</div>';
        editors.css.value = '* {\n  margin: 0;\n  padding: 0;\n  box-sizing: border-box;\n}\n\nbody {\n  display: flex;\n  justify-content: center;\n  align-items: center;\n  height: 100vh;\n  background: #18181b;\n  color: #fff;\n  font-family: sans-serif;\n}\n\n.card {\n  padding: 2rem;\n  border: 1px solid #333;\n  border-radius: 8px;\n  text-align: center;\n  background: #27272a;\n}\n\nbutton {\n  margin-top: 10px;\n  padding: 8px 16px;\n  background: #8b5cf6;\n  color: white;\n  border: none;\n  border-radius: 4px;\n  cursor: pointer;\n}';
        editors.js.value = 'function testar() {\n  console.log("Ol√° do console!");\n  alert("Funcionando!");\n}';
        
        updateHighlight('html'); updateHighlight('css'); updateHighlight('js');
        runCode();

    </script>
</body>
</html>
