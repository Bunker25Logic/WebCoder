<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Bunker25 Logic - Dev Terminal</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <!-- Bunker25 Typography -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&family=Oxanium:wght@400;600&family=Fira+Code:wght@400;600&display=swap" rel="stylesheet">
    
    <style>
        /* --- BUNKER25 IDENTITY SYSTEM --- */
        :root {
            /* Paleta Oficial */
            --bunker-bg: #1A0B2E;       /* Roxo Profundo */
            --bunker-panel: #240d42;    /* Roxo Painel */
            --bunker-neon-green: #39FF14; /* AÃ§Ã£o / Sucesso */
            --bunker-cobalt: #2E5BFF;   /* Estrutura / Borda */
            --bunker-text: #e0e0e0;
            
            /* Syntax Highlighting (Synthwave Theme) */
            --syntax-text: #f8f8f2;
            --syntax-keyword: #ff79c6;  /* Pink */
            --syntax-string: #39FF14;   /* Bunker Green */
            --syntax-tag: #2E5BFF;      /* Bunker Cobalt */
            --syntax-attr: #8be9fd;     /* Cyan */
            --syntax-comment: #6272a4;  /* GrayBlue */
            --syntax-func: #bd93f9;     /* Purple Light */
            --syntax-number: #ffb86c;   /* Orange */
        }

        body {
            background-color: var(--bunker-bg);
            color: var(--bunker-text);
            font-family: 'Oxanium', sans-serif; /* Fonte Corpo */
            overflow: hidden;
        }

        /* --- TIPOGRAFIA --- */
        .font-brand { font-family: 'Orbitron', sans-serif; }
        .font-ui { font-family: 'Oxanium', sans-serif; }
        .font-code { font-family: 'Fira Code', monospace; }

        /* --- UI ELEMENTS COM GLOW --- */
        header {
            background-color: rgba(26, 11, 46, 0.95);
            border-bottom: 1px solid var(--bunker-cobalt);
            box-shadow: 0 0 15px rgba(46, 91, 255, 0.2);
        }

        .btn-action {
            background-color: transparent;
            border: 1px solid var(--bunker-neon-green);
            color: var(--bunker-neon-green);
            transition: all 0.2s ease;
            text-transform: uppercase;
            letter-spacing: 1px;
            font-family: 'Orbitron', sans-serif;
            font-size: 0.7rem;
        }
        .btn-action:hover {
            background-color: var(--bunker-neon-green);
            color: var(--bunker-bg);
            box-shadow: 0 0 10px var(--bunker-neon-green);
        }

        .btn-icon {
            color: var(--bunker-cobalt);
            transition: all 0.2s;
        }
        .btn-icon:hover {
            color: #fff;
            text-shadow: 0 0 5px var(--bunker-cobalt);
        }

        /* --- EDITOR ENGINE --- */
        .editor-container {
            position: relative;
            width: 100%;
            height: 100%;
            background-color: var(--bunker-bg);
            overflow: hidden; 
        }

        .editor-textarea, .editor-highlight {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            padding: 1rem;
            margin: 0;
            border: none;
            font-family: 'Fira Code', monospace;
            font-size: 14px;
            line-height: 1.6;
            tab-size: 2;
            white-space: pre;
            overflow: auto;
            text-align: left;
        }
        
        @media (max-width: 640px) {
            .editor-textarea, .editor-highlight {
                font-size: 13px;
                padding: 12px;
            }
        }

        .editor-textarea {
            background: transparent;
            color: transparent;
            caret-color: var(--bunker-neon-green); /* Cursor Verde Neon */
            z-index: 2;
            resize: none;
            outline: none;
        }

        .editor-highlight {
            background-color: var(--bunker-bg);
            color: var(--syntax-text);
            z-index: 1;
            pointer-events: none;
        }

        /* Syntax Classes */
        .token-keyword { color: var(--syntax-keyword); font-weight: bold; }
        .token-string { color: var(--syntax-string); }
        .token-tag { color: var(--syntax-tag); font-weight: bold; }
        .token-attr { color: var(--syntax-attr); font-style: italic; }
        .token-comment { color: var(--syntax-comment); }
        .token-func { color: var(--syntax-func); }
        .token-number { color: var(--syntax-number); }
        .token-selector { color: var(--syntax-keyword); } /* CSS Selectors Pink */
        
        /* --- TABS --- */
        .tab-container {
            background: #130821; /* Darker bg for tabs */
            border-bottom: 1px solid var(--bunker-cobalt);
        }
        
        .tab-btn {
            background: transparent;
            color: #6272a4;
            border-bottom: 2px solid transparent;
            transition: all 0.2s;
            font-family: 'Oxanium', sans-serif;
            text-transform: uppercase;
        }
        .tab-btn:hover { color: #fff; }
        .tab-btn.active { 
            background: rgba(46, 91, 255, 0.1); 
            color: #fff; 
        }
        /* Tab indicator colors matches Brand */
        .tab-btn.active-html { border-bottom-color: #f97316; } /* Orange contrast */
        .tab-btn.active-css { border-bottom-color: var(--bunker-cobalt); } /* Brand Blue */
        .tab-btn.active-js { border-bottom-color: var(--bunker-neon-green); } /* Brand Green */

        /* Scrollbar Bunker Style */
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: var(--bunker-bg); }
        ::-webkit-scrollbar-thumb { background: var(--bunker-cobalt); border-radius: 0px; }
        ::-webkit-scrollbar-thumb:hover { background: #4d73ff; }

        /* --- INTELLISENSE BOX --- */
        #suggestion-box {
            position: absolute;
            background-color: rgba(26, 11, 46, 0.98);
            border: 1px solid var(--bunker-cobalt);
            border-radius: 0px; /* Angular/Tech feel */
            box-shadow: 0 4px 20px rgba(0,0,0,0.8);
            z-index: 100;
            width: 240px;
            max-height: 200px;
            overflow-y: auto;
            display: none;
            flex-direction: column;
        }

        .suggestion-item {
            padding: 8px 12px;
            font-size: 12px;
            font-family: 'Fira Code', monospace;
            color: var(--bunker-text);
            cursor: pointer;
            border-bottom: 1px solid rgba(46, 91, 255, 0.2);
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .suggestion-item:hover, .suggestion-item.active {
            background-color: rgba(46, 91, 255, 0.2); /* Blue tint */
            color: #fff;
            border-left: 3px solid var(--bunker-neon-green);
        }
        
        .suggestion-icon { font-size: 11px; min-width: 16px; text-align: center; }
        .icon-snippet { color: var(--bunker-neon-green); } 
        .icon-tag { color: var(--syntax-keyword); } 
        .icon-prop { color: var(--bunker-cobalt); }

        /* --- LAYOUT SYSTEM --- */
        .view-editor, .view-preview { display: none; flex-direction: column; height: 100%; }

        body.mode-editor .view-editor { display: flex; width: 100%; }
        body.mode-preview .view-preview { display: flex; width: 100%; }

        @media (min-width: 768px) {
            body.mode-split .view-editor { display: flex; width: 50%; }
            body.mode-split .view-preview { display: flex; width: 50%; }
        }
        @media (max-width: 767px) {
            body.mode-split .view-editor { display: flex; width: 100%; }
            body.mode-split .view-preview { display: none; }
        }

        /* Layout Buttons */
        .layout-btn {
            padding: 6px;
            border-radius: 2px;
            color: #6272a4;
            transition: all 0.3s;
        }
        .layout-btn:hover { color: var(--bunker-neon-green); }
        .layout-btn.active {
            color: var(--bunker-neon-green);
            text-shadow: 0 0 8px var(--bunker-neon-green);
            background: rgba(57, 255, 20, 0.05);
        }

        /* Status Bar */
        .status-bar {
            background: #130821;
            border-top: 1px solid var(--bunker-cobalt);
            color: var(--bunker-cobalt);
            font-family: 'Orbitron', sans-serif;
            font-size: 10px;
            letter-spacing: 1px;
        }

        /* Preview Frame border */
        #preview-frame {
            border-left: 1px solid var(--bunker-cobalt);
            background: #fff; /* O preview em si precisa ser neutro */
        }
    </style>
</head>

<!-- BUNKER25 LOGIC SYSTEM - START -->
<body class="flex flex-col h-screen select-none mode-split" id="main-body">

    <!-- Header Bunker25 -->
    <header class="flex items-center justify-between px-4 h-14 shrink-0 z-20">
        <div class="flex items-center gap-4">
            <!-- Brand Logo -->
            <div class="flex items-center gap-2 group cursor-default">
                <div class="p-1.5 border border-[#39FF14] bg-[#39FF14]/10 rounded-sm shadow-[0_0_10px_rgba(57,255,20,0.3)]">
                    <i data-lucide="terminal" class="text-[#39FF14] w-4 h-4"></i>
                </div>
                <div class="flex flex-col">
                    <h1 class="font-brand font-bold text-sm tracking-widest text-white leading-tight">BUNKER<span class="text-[#39FF14]">25</span></h1>
                    <span class="font-brand text-[8px] text-[#2E5BFF] tracking-[0.2em] leading-tight">LOGIC SYSTEM</span>
                </div>
            </div>
            
            <!-- Divider -->
            <div class="h-6 w-px bg-[#2E5BFF]/30 hidden sm:block"></div>

            <!-- Unified Layout Controls -->
            <div class="flex items-center bg-[#130821] border border-[#2E5BFF]/30 rounded-sm p-0.5">
                <button onclick="setLayout('editor')" id="btn-layout-editor" class="layout-btn" title="Editor [Tela Cheia]">
                    <i data-lucide="file-code-2" class="w-4 h-4"></i>
                </button>
                <button onclick="setLayout('split')" id="btn-layout-split" class="layout-btn hidden md:flex" title="Split [Dividir]">
                    <i data-lucide="columns" class="w-4 h-4"></i>
                </button>
                <button onclick="setLayout('preview')" id="btn-layout-preview" class="layout-btn" title="Preview [Monitor]">
                    <i data-lucide="monitor-play" class="w-4 h-4"></i>
                </button>
            </div>
        </div>

        <div class="flex items-center gap-3">
            <button onclick="formatCurrentCode()" class="btn-icon p-2 hover:animate-pulse" title="Auto Format [LÃ³gica]">
                <i data-lucide="wand-2" class="w-4 h-4"></i>
            </button>
            <button onclick="runCode()" class="btn-action flex items-center gap-2 px-4 py-1.5 rounded-sm">
                <i data-lucide="play" class="w-3 h-3"></i> <span class="hidden sm:inline">EXECUTE</span>
            </button>
        </div>
    </header>

    <!-- Main Content -->
    <main class="flex flex-1 overflow-hidden relative">
        
        <!-- Editor Section -->
        <div class="view-editor flex-col border-r border-[#2E5BFF]/30 h-full relative">
            
            <!-- Tabs -->
            <div class="tab-container flex shrink-0">
                <button onclick="switchTab('html')" id="tab-html" class="tab-btn active active-html flex-1 py-3 text-xs font-bold tracking-wider">HTML</button>
                <button onclick="switchTab('css')" id="tab-css" class="tab-btn flex-1 py-3 text-xs font-bold tracking-wider">CSS</button>
                <button onclick="switchTab('js')" id="tab-js" class="tab-btn flex-1 py-3 text-xs font-bold tracking-wider">JS</button>
            </div>

            <!-- Editor Area -->
            <div class="relative flex-1 bg-[#1A0B2E]">
                
                <!-- Floating Suggestion Box -->
                <div id="suggestion-box"></div>

                <!-- HTML -->
                <div id="wrapper-html" class="editor-container">
                    <pre class="editor-highlight" aria-hidden="true"><code id="hl-html"></code></pre>
                    <textarea id="editor-html" class="editor-textarea" spellcheck="false" 
                        oninput="handleInput(event, this); updateHighlight('html')" 
                        onscroll="syncScroll('html')"
                        onclick="hideSuggestions()"
                        placeholder="// Digite ! para iniciar o sistema..."></textarea>
                </div>

                <!-- CSS -->
                <div id="wrapper-css" class="editor-container hidden">
                    <pre class="editor-highlight" aria-hidden="true"><code id="hl-css"></code></pre>
                    <textarea id="editor-css" class="editor-textarea" spellcheck="false" 
                        oninput="handleInput(event, this); updateHighlight('css')" 
                        onscroll="syncScroll('css')"
                        onclick="hideSuggestions()"
                        placeholder="/* Digite * para resetar estilos... */"></textarea>
                </div>

                <!-- JS -->
                <div id="wrapper-js" class="editor-container hidden">
                    <pre class="editor-highlight" aria-hidden="true"><code id="hl-js"></code></pre>
                    <textarea id="editor-js" class="editor-textarea" spellcheck="false" 
                        oninput="handleInput(event, this); updateHighlight('js')" 
                        onscroll="syncScroll('js')"
                        onclick="hideSuggestions()"
                        placeholder="// Digite log para depurar..."></textarea>
                </div>
            </div>

            <!-- Status Bar -->
            <div class="status-bar py-1 px-3 flex justify-between shrink-0">
                <span id="status-msg" class="flex items-center gap-2"><div class="w-1.5 h-1.5 bg-[#39FF14] rounded-full animate-pulse"></div> SYSTEM READY</span>
                <span id="cursor-pos">LN 1 : COL 1</span>
            </div>
        </div>

        <!-- Preview Section -->
        <div class="view-preview flex-col bg-[#130821] h-full relative">
            <!-- Label no modo mobile para saber que Ã© preview -->
            <div class="md:hidden bg-[#130821] border-b border-[#2E5BFF]/30 text-[#2E5BFF] font-brand text-[10px] px-2 py-1 tracking-widest">
                OUTPUT DISPLAY
            </div>

            <iframe id="preview-frame" sandbox="allow-scripts allow-modals" class="w-full h-full bg-white"></iframe>
            
            <!-- Console Overlay Bunker Style -->
            <div id="console-logs" class="hidden absolute bottom-0 left-0 right-0 bg-[#1A0B2E]/95 text-[#e0e0e0] text-xs flex flex-col max-h-48 border-t border-[#2E5BFF] z-20">
                <div class="flex justify-between items-center p-2 bg-[#130821] border-b border-[#2E5BFF]/30">
                    <span class="font-brand text-[#2E5BFF] text-[10px] tracking-widest">SYSTEM TERMINAL</span>
                    <button onclick="document.getElementById('console-logs').classList.add('hidden')" class="text-[#2E5BFF] hover:text-white font-mono">[X]</button>
                </div>
                <div id="logs-content" class="overflow-y-auto p-2 font-code space-y-1"></div>
            </div>
        </div>
    </main>

    <script>
        lucide.createIcons();

        // --- ESTADO & CONFIG ---
        let currentLang = 'html';
        const editors = { html: document.getElementById('editor-html'), css: document.getElementById('editor-css'), js: document.getElementById('editor-js') };
        const highlights = { html: document.getElementById('hl-html'), css: document.getElementById('hl-css'), js: document.getElementById('hl-js') };
        const suggestionBox = document.getElementById('suggestion-box');
        
        // --- REPOSITÃ“RIO BUNKER25 SNIPPETS ---
        const snippets = {
            html: {
                '!': '<!DOCTYPE html>\n<html lang="pt-BR">\n<head>\n  <meta charset="UTF-8">\n  <meta name="viewport" content="width=device-width, initial-scale=1.0">\n  <title>Bunker Project</title>\n</head>\n<body>\n  |\n</body>\n</html>',
                'meta': '<meta name="viewport" content="width=device-width, initial-scale=1.0">',
                'link': '<link rel="stylesheet" href="|">',
                'style': '<style>\n  |\n</style>',
                'script': '<script>\n  |\n<\/script>',
                'div': '<div>|</div>',
                'span': '<span>|</span>',
                'header': '<header>\n  |\n</header>',
                'footer': '<footer>\n  |\n</footer>',
                'main': '<main>\n  |\n</main>',
                'section': '<section>\n  |\n</section>',
                'nav': '<nav>\n  |\n</nav>',
                'h1': '<h1>|</h1>',
                'h2': '<h2>|</h2>',
                'p': '<p>|</p>',
                'a': '<a href="|">Link</a>',
                'img': '<img src="|" alt="">',
                'ul': '<ul>\n  <li>|</li>\n</ul>',
                'li': '<li>|</li>',
                'form': '<form action="">\n  |\n</form>',
                'input': '<input type="text" placeholder="|">',
                'button': '<button type="button">|</button>',
                'table': '<table>\n  <tr>\n    <td>|</td>\n  </tr>\n</table>'
            },
            
            css: {
                '*': '* {\n  margin: 0;\n  padding: 0;\n  box-sizing: border-box;\n}\n\n|',
                'body': 'body {\n  font-family: sans-serif;\n  background-color: #f4f4f5;\n  color: #18181b;\n  |;\n}',
                'flex': 'display: flex;',
                'flex-col': 'display: flex;\nflex-direction: column;',
                'flex-center': 'display: flex;\njustify-content: center;\nalign-items: center;',
                'grid': 'display: grid;\ngrid-template-columns: repeat(2, 1fr);\ngap: 1rem;',
                'rel': 'position: relative;',
                'abs': 'position: absolute;\ntop: 0;\nleft: 0;',
                'm': 'margin: |;',
                'p': 'padding: |;',
                'w': 'width: |;',
                'h': 'height: |;',
                'w100': 'width: 100%;',
                'h100': 'height: 100vh;',
                'bg': 'background-color: |;',
                'color': 'color: |;',
                'border': 'border: 1px solid #ccc;',
                '@media': '@media (max-width: 768px) {\n  |\n}'
            },
            
            js: {
                'log': 'console.log(|);',
                'warn': 'console.warn(|);',
                'error': 'console.error(|);',
                'const': 'const | = ;',
                'let': 'let | = ;',
                'fun': 'function |() {\n  \n}',
                'if': 'if (|) {\n  \n}',
                'else': 'else {\n  |\n}',
                'for': 'for (let i = 0; i < |; i++) {\n  \n}',
                'doc': 'document.',
                'get': 'document.getElementById("|")',
                'qs': 'document.querySelector("|")',
                'ae': 'addEventListener("|", (event) => {\n  \n});',
                'map': '.map(item => |)',
                'fetch': 'fetch("|")\n  .then(res => res.json())\n  .then(data => console.log(data));'
            }
        };

        const commonKeywords = {
            html: ['id', 'class', 'src', 'href', 'type', 'placeholder', 'value', 'name', 'style', 'onclick', 'hidden', 'disabled', 'required'],
            css: ['display', 'position', 'margin', 'padding', 'border', 'width', 'height', 'top', 'left', 'bottom', 'right', 'z-index', 'overflow', 'color', 'background', 'opacity', 'cursor', 'font-size', 'text-align'],
            js: ['null', 'undefined', 'true', 'false', 'this', 'new', 'class', 'export', 'import', 'from', 'await', 'async', 'Math', 'JSON', 'window', 'document', 'localStorage']
        };

        const keywords = {
            html: [...new Set([...Object.keys(snippets.html), ...commonKeywords.html])].sort(),
            css: [...new Set([...Object.keys(snippets.css), ...commonKeywords.css])].sort(),
            js: [...new Set([...Object.keys(snippets.js), ...commonKeywords.js])].sort()
        };

        // --- LAYOUT SYSTEM ---
        function setLayout(mode) {
            document.body.classList.remove('mode-editor', 'mode-split', 'mode-preview');
            document.body.classList.add(`mode-${mode}`);
            document.querySelectorAll('.layout-btn').forEach(btn => btn.classList.remove('active', 'text-white'));
            const activeBtn = document.getElementById(`btn-layout-${mode}`);
            if(activeBtn) {
                activeBtn.classList.add('active');
                activeBtn.classList.remove('text-gray-400');
            }
        }

        if (window.innerWidth < 768) setLayout('editor'); else setLayout('split');

        // --- TABS ---
        function switchTab(lang) {
            currentLang = lang;
            ['html', 'css', 'js'].forEach(l => {
                document.getElementById(`wrapper-${l}`).classList.add('hidden');
                document.getElementById(`tab-${l}`).classList.remove('active', `active-${l}`);
            });
            document.getElementById(`wrapper-${lang}`).classList.remove('hidden');
            document.getElementById(`tab-${lang}`).classList.add('active', `active-${lang}`);
            updateHighlight(lang);
            hideSuggestions();
        }

        function syncScroll(lang) {
            const textarea = editors[lang];
            const pre = highlights[lang].parentElement;
            pre.scrollTop = textarea.scrollTop;
            pre.scrollLeft = textarea.scrollLeft;
        }

        // --- INPUT & SUGGESTION ---
        function handleInput(e, textarea) {
            const cursor = textarea.selectionStart;
            const text = textarea.value;
            const textBefore = text.substring(0, cursor);
            // Regex ajustado para permitir * ! @ - _
            const match = textBefore.match(/([a-zA-Z0-9_\-@!*]+)$/);
            const word = match ? match[0] : '';

            if (word.length > 0) {
                const list = keywords[currentLang].filter(k => k.toLowerCase().startsWith(word.toLowerCase()));
                if (list.length > 0) {
                    showSuggestions(list, word, textarea);
                    return;
                }
            }
            hideSuggestions();
        }

        function getCaretCoordinates(element, position) {
            const div = document.createElement('div');
            const style = getComputedStyle(element);
            Array.from(style).forEach(prop => { div.style[prop] = style.getPropertyValue(prop); });
            div.style.position = 'absolute'; div.style.visibility = 'hidden'; div.style.whiteSpace = 'pre-wrap';
            div.style.top = 0; div.style.left = 0;
            div.textContent = element.value.substring(0, position);
            const span = document.createElement('span'); span.textContent = '|';
            div.appendChild(span);
            document.body.appendChild(div);
            const coords = {
                top: span.offsetTop + element.offsetTop - element.scrollTop,
                left: span.offsetLeft + element.offsetLeft - element.scrollLeft,
                lineHeight: parseInt(style.lineHeight)
            };
            document.body.removeChild(div);
            return coords;
        }

        function showSuggestions(list, word, textarea) {
            suggestionBox.innerHTML = '';
            list.slice(0, 15).forEach((item, idx) => {
                const el = document.createElement('div');
                el.className = `suggestion-item ${idx === 0 ? 'active' : ''}`;
                
                let icon = 'ðŸ”¹';
                let className = 'icon-tag';
                if(snippets[currentLang][item]) { icon = 'âš¡'; className = 'icon-snippet'; }
                else if (currentLang === 'css' && item.includes(':')) { icon = 'ðŸŽ¨'; className = 'icon-prop'; }

                el.innerHTML = `<span class="suggestion-icon ${className}">${icon}</span> ${item}`;
                el.onmousedown = (e) => { e.preventDefault(); applySuggestion(item, word); };
                suggestionBox.appendChild(el);
            });

            const coords = getCaretCoordinates(textarea, textarea.selectionStart);
            let leftPos = coords.left;
            if (leftPos + 240 > window.innerWidth) leftPos = window.innerWidth - 250;

            suggestionBox.style.top = `${coords.top + coords.lineHeight + 5}px`;
            suggestionBox.style.left = `${leftPos}px`;
            suggestionBox.style.display = 'flex';
        }

        function hideSuggestions() { suggestionBox.style.display = 'none'; }

        function applySuggestion(suggestion, originalWord) {
            const textarea = editors[currentLang];
            const start = textarea.selectionStart - originalWord.length;
            const end = textarea.selectionStart;
            
            let snippet = snippets[currentLang][suggestion];
            if (!snippet) {
                if(currentLang === 'html') {
                    const isAttr = commonKeywords.html.includes(suggestion);
                    if (!isAttr) snippet = `<${suggestion}>|</${suggestion}>`; else snippet = `${suggestion}="|"`;
                }
                else if(currentLang === 'css') snippet = `${suggestion}: |;`;
                else snippet = suggestion;
            }

            let finalStr = snippet;
            let offset = snippet.length;
            if (snippet.includes('|')) {
                const parts = snippet.split('|');
                finalStr = parts.join('');
                offset = parts[0].length;
            }

            textarea.setRangeText(finalStr, start, end, 'end');
            const newPos = start + offset;
            textarea.setSelectionRange(newPos, newPos);
            hideSuggestions(); updateHighlight(currentLang); runCode(); textarea.focus();
        }

        // --- FORMATTER ---
        function formatCurrentCode() {
            const textarea = editors[currentLang];
            let code = textarea.value;
            let formatted = "";
            let indent = 0;
            const pad = "  ";

            code.split('\n').map(l => l.trim()).filter(l => l.length > 0).forEach(line => {
                if (line.match(/^<\//) || line.startsWith('}') || line.startsWith(']')) indent = Math.max(0, indent - 1);
                formatted += pad.repeat(indent) + line + "\n";
                const isOpeningTag = (currentLang === 'html') && line.match(/^<[a-z0-9]+[^>]*>$/i) && !line.match(/<\//) && !line.match(/\/>/) && !line.startsWith('<!');
                if (line.endsWith('{') || line.endsWith('[') || isOpeningTag) indent++;
            });
            textarea.value = formatted.trim();
            updateHighlight(currentLang);
            runCode();
        }

        // --- KEYS ---
        Object.values(editors).forEach(ed => {
            ed.addEventListener('keydown', e => {
                if (suggestionBox.style.display !== 'none') {
                    if (e.key === 'ArrowDown' || e.key === 'ArrowUp') {
                        e.preventDefault();
                        const items = Array.from(suggestionBox.children);
                        let activeIdx = items.findIndex(el => el.classList.contains('active'));
                        if (activeIdx !== -1) items[activeIdx].classList.remove('active');
                        if (e.key === 'ArrowDown') activeIdx = (activeIdx + 1) % items.length;
                        else activeIdx = (activeIdx - 1 + items.length) % items.length;
                        items[activeIdx].classList.add('active');
                        items[activeIdx].scrollIntoView({ block: 'nearest' });
                        return;
                    }
                    if (e.key === 'Enter' || e.key === 'Tab') {
                        e.preventDefault();
                        const active = suggestionBox.querySelector('.active');
                        if (active) active.onmousedown(e);
                        return;
                    }
                }
                if (e.key === 'Tab') { e.preventDefault(); document.execCommand('insertText', false, '  '); }
            });
            ed.addEventListener('keyup', () => {
                const lines = ed.value.substr(0, ed.selectionStart).split("\n");
                document.getElementById('cursor-pos').innerText = `LN ${lines.length} : COL ${lines[lines.length-1].length + 1}`;
            });
        });

        // --- HIGHLIGHT & RUN ---
        function escapeHtml(text) { return text.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;"); }

        function highlightCode(code, lang) {
            let res = escapeHtml(code);
            if (lang === 'html') {
                res = res.replace(/(&lt;!--[\s\S]*?--&gt;)/g, '<span class="token-comment">$1</span>');
                res = res.replace(/(&lt;\/?)([a-zA-Z0-9-]+)(.*?)(\/?&gt;)/g, (m, p1, p2, p3, p4) => 
                    `<span class="token-tag">${p1}${p2}</span>${p3.replace(/([a-zA-Z-]+)=/g, '<span class="token-attr">$1</span>=')}<span class="token-tag">${p4}</span>`);
            } else if (lang === 'css') {
                res = res.replace(/([^{]+)\{/g, '<span class="token-selector">$1</span>{');
                res = res.replace(/([a-zA-Z-]+):/g, '<span class="token-attr">$1</span>:');
            } else if (lang === 'js') {
                res = res.replace(/(\/\/.*)/g, '<span class="token-comment">$1</span>');
                res = res.replace(/\b(const|let|var|function|return|if|else|for|while|class|try|catch|async|await|new|import|from)\b/g, '<span class="token-keyword">$1</span>');
                res = res.replace(/(["'`].*?["'`])/g, '<span class="token-string">$1</span>');
                res = res.replace(/\b(console|document|window|Math|JSON)\b/g, '<span class="token-func">$1</span>');
            }
            return res + '\n';
        }

        function updateHighlight(lang) { highlights[lang].innerHTML = highlightCode(editors[lang].value, lang); }

        function runCode() {
            const html = editors.html.value; const css = editors.css.value; const js = editors.js.value;
            const consoleFix = `<script>
                const _log = console.log; console.log = (...a) => { window.parent.postMessage({type:'log', msg: a.join(' ')}, '*'); _log(...a); };
                const _err = console.error; console.error = (...a) => { window.parent.postMessage({type:'log', msg: 'ðŸ”´ ' + a.join(' ')}, '*'); _err(...a); };
                window.onerror = (m) => window.parent.postMessage({type:'log', msg: 'ðŸ”´ '+m}, '*');
            <\/script>`;
            const blob = new Blob([`<html><head><style>${css}</style></head><body>${html}${consoleFix}<script>${js}<\/script></body></html>`], {type: 'text/html'});
            document.getElementById('preview-frame').src = URL.createObjectURL(blob);
        }

        window.addEventListener('message', (e) => {
            if(e.data.type === 'log') {
                const box = document.getElementById('console-logs');
                const content = document.getElementById('logs-content');
                box.classList.remove('hidden');
                const div = document.createElement('div');
                div.innerHTML = `> ${e.data.msg}`;
                div.className = "border-b border-[#2E5BFF]/20 pb-1";
                if(e.data.msg.toString().includes('ðŸ”´')) div.style.color = '#ff5555';
                content.appendChild(div);
                content.scrollTop = content.scrollHeight;
            }
        });

        // Demo Content Bunker Style
        editors.html.value = `<div class="bunker-terminal">
  <h1>BUNKER<span class="highlight">25</span></h1>
  <p>SYSTEM ONLINE. READY FOR INPUT.</p>
  <button onclick="accessSystem()">ACCESS</button>
</div>`;

        editors.css.value = `* { margin: 0; padding: 0; box-sizing: border-box; }

body {
  background: #0f0518;
  color: #39FF14;
  font-family: 'Courier New', monospace;
  height: 100vh;
  display: flex;
  justify-content: center;
  align-items: center;
}

.bunker-terminal {
  border: 2px solid #2E5BFF;
  padding: 3rem;
  box-shadow: 0 0 20px rgba(46, 91, 255, 0.4);
  text-align: center;
  background: rgba(26, 11, 46, 0.9);
}

h1 { font-size: 2.5rem; letter-spacing: 5px; margin-bottom: 1rem; color: #fff; }
.highlight { color: #39FF14; }

button {
  margin-top: 2rem;
  padding: 10px 30px;
  background: transparent;
  border: 1px solid #39FF14;
  color: #39FF14;
  font-weight: bold;
  cursor: pointer;
  transition: 0.3s;
}

button:hover {
  background: #39FF14;
  color: #000;
  box-shadow: 0 0 15px #39FF14;
}`;

        editors.js.value = `function accessSystem() {
  console.log("ACCESS GRANTED.");
  alert("WELCOME TO BUNKER25 LOGIC.");
}`;
        
        updateHighlight('html'); updateHighlight('css'); updateHighlight('js');
        runCode();
    </script>
</body>
</html>


